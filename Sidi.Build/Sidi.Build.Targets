<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <SidiBuildAssembly>$(MSBuildExtensionsPath)\sidi-util\Sidi.Build.dll</SidiBuildAssembly>
  </PropertyGroup>
  <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
  <UsingTask AssemblyFile="$(SidiBuildAssembly)" TaskName="Sidi.Build.CreateUpdateInfo" />
  <UsingTask AssemblyFile="$(SidiBuildAssembly)" TaskName="Sidi.Build.GoogleCode.Upload" />
  <UsingTask AssemblyFile="$(SidiBuildAssembly)" TaskName="Sidi.Build.SourceIndex" />

    <PropertyGroup>
        <RootDir>$(MSBuildProjectDirectory)</RootDir>
        <BuildDir>$(RootDir)\..\build\$(ProjectName)</BuildDir>
        <OutputDir>$(BuildDir)\bin\Release</OutputDir>
        <PackageDir>$(BuildDir)\Package</PackageDir>
        <DocDir>$(RootDir)\doc</DocDir>
        <PackageFileName>$(PackageDir)\$(ProjectName)-$(Version).zip</PackageFileName>
        <SvnRoot>https://$(ProjectName).googlecode.com/svn</SvnRoot>
    </PropertyGroup>
  
    <ItemGroup>
        <ZipFiles Include="$(OutputDir)\**\*.*" />
        <DocFiles Include="$(OutputDir)\$(ProjectName).chm" />
    </ItemGroup>
    
    <Target Name="Commit" >
        <SvnCommit 
            Targets="$(MSBuildProjectDirectory)"
            Message="Auto commit from MSBuild." >
        </SvnCommit>
    </Target>

    <Target Name="UpdateVersion" DependsOnTargets="Commit;GetVersion">
        <SvnCopy 
            SourcePath="$(SvnRoot)/trunk"
            DestinationPath="$(SvnRoot)/tags/$(Version)" 
            Message="Automatic build of $(ProjectName)" />
        <AssemblyInfo CodeLanguage="CS"
            OutputFile="VersionInfo.cs" 
            AssemblyVersion="$(Version)" 
            AssemblyFileVersion="$(Version)" />
    </Target>

    <Target Name="GetVersion" >
        <SvnVersion 
            LocalPath=".">
            <Output TaskParameter="Revision" PropertyName="Revision" />
        </SvnVersion>
        <CreateProperty
            Value="$(Major).$(Minor).$(Build).$(Revision)">
            <Output
                TaskParameter="Value"
                PropertyName="Version" />
        </CreateProperty>
        <Message Text="Version is $(Version)" />
        <AssemblyInfo CodeLanguage="CS"
            OutputFile="VersionInfo.cs" 
            AssemblyVersion="$(Version)" 
            AssemblyFileVersion="$(Version)" />
    </Target>

  <Target Name="Build" DependsOnTargets="UpdateVersion">
        <MSBuild
            Projects="$(ProjectName).sln" Properties="Configuration=Release;Platform=Any CPU">
            <Output ItemName="Targets" TaskParameter="TargetOutputs"/>
        </MSBuild>
    </Target>

    <Target Name="Doc" DependsOnTargets="Build"
        Inputs="@(Targets)"
        Outputs="@(DocFiles)"
        >
        <NDoc
            Documenter="MSDN-CHM"
            ProjectFilePath="$(ProjectName).ndoc"
            WorkingDirectory="$(DocDir)"
            ToolPath="c:\Program Files\NDoc 2.0"
            />
        <DeleteTree Directories="$(OutputDir)\ndoc_msdn_temp" />
    </Target>
            
    <Target Name="Package" DependsOnTargets="Build;Doc;SourceIndex">
        <MakeDir Directories="$(PackageDir)" Condition="!Exists('$(PackageDir)')" />
        <Zip
            Files="@(ZipFiles)"
            WorkingDirectory="$(OutputDir)"
            ZipFileName="$(PackageDir)\$(ProjectName)-$(Version).zip" />
    </Target>

    <Target Name="SourceIndex" DependsOnTargets="Build">
        <Sidi.Build.SourceIndex
            Directory = "$(MSBuildProjectDirectory)"
            Url = "$(SvnRoot)/tags/$(Version)/"
            Modules = "@(Targets)"
            />
    </Target>

    <Target Name="Install" DependsOnTargets="Package">
        <RoboCopy 
                SourceFolder="$(BuildDir)\bin" 
                DestinationFolder="D:\work\lib\$(ProjectName)\bin" 
                Mirror="true"
            />  
    </Target>

    <Target Name="Upload" DependsOnTargets="Commit;Package">
        <GoogleCode.Upload
            ProjectName="$(ProjectName)"
            LocalFile="$(PackageDir)\$(ProjectName)-$(Version).zip"
            RemoteFile="$(ProjectName)-$(Version).zip"
            Summary="Build for Version $(Version)"
            />
    </Target>
    
    <Target Name="Release" DependsOnTargets="Upload;Install" />

</Project>
