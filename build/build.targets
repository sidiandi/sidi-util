<?xml version="1.0" encoding="utf-8"?>
<!--Copyright (c) 2014, Andreas Grimme (http://andreas-grimme.gmxhome.de/)

This file is part of sidi-util.

sidi-util is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

sidi-util is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with sidi-util. If not, see <http://www.gnu.org/licenses/>.-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<SourceDir>$([System.IO.Directory]::GetParent($(MSBuildProjectDirectory)))</SourceDir>

		<NugetPackagesDir>$(SourceDir)\..\nuget-packages</NugetPackagesDir>
		
		<NUnitBin>$(NugetPackagesDir)\NUnit.Runners.2.6.4\tools</NUnitBin>
		<NUnitConsole>$(NUnitBin)\nunit-console-x86.exe</NUnitConsole>
		
		<Nuget>$(SourceDir)\.nuget\NuGet.exe</Nuget>
		<NuSpec>$(SourceDir)\$(ProductName).nuspec</NuSpec>
		<NugetPackDir>$(OutDir)\NugetPack</NugetPackDir>
  </PropertyGroup>

	<PropertyGroup>
	<MSBuildCommunityTasksPath>$(SourceDir)\build</MSBuildCommunityTasksPath>
  </PropertyGroup>
	<Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets" />

  <Target Name="GetVersion" >
    <SvnVersion LocalPath=".">
      <Output TaskParameter="Revision" PropertyName="Revision" />
    </SvnVersion>
    <CreateProperty
        Value="$(Major).$(Minor).$(Build).$([MSBuild]::Subtract($(Revision), $(InitialRevision)))">
      <Output
          TaskParameter="Value"
          PropertyName="Version" />
    </CreateProperty>
    <Message Text="Version is $(Version)" />
	<ItemGroup>
		<AssemblyAttributes Include="AssemblyCopyright"><_Parameter1>Copyright (c) $(CompanyName) 2008-$([System.DateTime]::Now.ToString(`yyyy`))</_Parameter1></AssemblyAttributes>
		<AssemblyAttributes Include="AssemblyCompany"><_Parameter1>$(CompanyName)</_Parameter1></AssemblyAttributes>
		<AssemblyAttributes Include="AssemblyProduct"><_Parameter1>$(ProductName)</_Parameter1></AssemblyAttributes>
		<AssemblyAttributes Include="AssemblyVersion"><_Parameter1>$(Version)</_Parameter1></AssemblyAttributes>
		<AssemblyAttributes Include="AssemblyFileVersion"><_Parameter1>$(Version)</_Parameter1></AssemblyAttributes>
	</ItemGroup>
  </Target>

  <Target Name="Build">
    <MSBuild
        Projects="$(SourceDir)\$(ProductName).sln" Properties="Configuration=$(Configuration);Platform=Any CPU;BuildDir=$(BuildDir)">
      <Output ItemName="Targets" TaskParameter="TargetOutputs"/>
    </MSBuild>
	<CreateProperty Value="$(OutDir)\sidi-util.3.1.0.0.nupkg">
            <Output
                TaskParameter="Value"
                PropertyName="Nupkg" />
	</CreateProperty>
  </Target>

  <Target Name="Test" DependsOnTargets="Build">
    <Exec Command="$(NUnitConsole) /xml=$(TestDir)\TestResult.xml /labels @(Targets, ' ')" />
  </Target>

  <Target Name="Release" DependsOnTargets="Build;Test" />

  <Target Name="PushLocal" DependsOnTargets="Build">
    <Exec WorkingDirectory="$(ReleaseDir)" Command="$(Nuget) push -Source $(NugetLocalFeed) $(Nupkg)" />
  </Target>

  <Target Name="Publish" DependsOnTargets="Release;NugetPush" />
  
  <!-- This target puts the build.log file into the build directory -->
  <Target Name="StartWrapper" >
	<MakeDir Directories="$(BuildDir)"/>
    <Exec
		Command="&quot;$(MSBuildBinPath)\msbuild.exe&quot; &quot;$(MSBuildProjectFullPath)&quot; /t:$(BuildTarget) &quot;/fileLoggerParameters:LogFile=$(BuildDir)\build.log;Verbosity=diagnostic;Encoding=UTF-8&quot;"
		/>
  </Target>

</Project>
