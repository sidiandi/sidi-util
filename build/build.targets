<?xml version="1.0" encoding="utf-8"?>
<!--Copyright (c) 2014, Andreas Grimme (http://andreas-grimme.gmxhome.de/)

This file is part of sidi-util.

sidi-util is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

sidi-util is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with sidi-util. If not, see <http://www.gnu.org/licenses/>.-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <SourceDir>$([System.IO.Directory]::GetParent($(MSBuildProjectDirectory)))</SourceDir>

    <NugetPackagesDir>$(SourceDir)\packages</NugetPackagesDir>
    
    <NUnitBin>$(NugetPackagesDir)\$(NUnitConsoleRunner)\tools</NUnitBin>
    <NUnitConsole>$(NUnitBin)\nunit3-console.exe</NUnitConsole>
    
    <Nuget>NuGet.exe</Nuget>
    <Git>git</Git>
  </PropertyGroup>

  <Import Project="$(NugetPackagesDir)\$(GitVersionTask)\build\dotnet\GitVersionTask.targets" />

  <Target Name="GetVersion">
    <GetVersion SolutionDirectory="$(SolutionDir)">
      <Output TaskParameter="Major" PropertyName="GfvMajor" />
      <Output TaskParameter="Minor" PropertyName="GfvMinor" />
      <Output TaskParameter="Patch" PropertyName="GfvPatch" />
      <Output TaskParameter="BuildMetaData" PropertyName="GfvBuildMetaData" />
      <Output TaskParameter="FullBuildMetaData" PropertyName="GfvFullBuildMetaData" />
      <Output TaskParameter="BranchName" PropertyName="GfvBranchName" />
      <Output TaskParameter="Sha" PropertyName="GfvSha" />
      <Output TaskParameter="MajorMinorPatch" PropertyName="GfvMajorMinorPatch" />
      <Output TaskParameter="SemVer" PropertyName="GfvSemVer" />
      <Output TaskParameter="LegacySemVer" PropertyName="GfvLegacySemVer" />
      <Output TaskParameter="LegacySemVerPadded" PropertyName="GfvLegacySemVerPadded" />
      <Output TaskParameter="FullSemVer" PropertyName="GfvFullSemVer" />
      <Output TaskParameter="AssemblySemVer" PropertyName="GfvAssemblySemVer" />
      <Output TaskParameter="NuGetVersion" PropertyName="GfvNuGetVersion" />
      <Output TaskParameter="PreReleaseTag" PropertyName="GfvPreReleaseTag" />
      <Output TaskParameter="PreReleaseTagWithDash" PropertyName="GfvPreReleaseTagWithDash" />
      <Output TaskParameter="InformationalVersion" PropertyName="GfvInformationalVersion" />
    </GetVersion>
    <Message Text="$(GfvSemVer)" />
    <Message Text="$(GfvNuGetVersion)" />
  </Target>

  <Target Name="Build" DependsOnTargets="GetVersion" >
    <MSBuild Projects="$(SourceDir)\$(ProductName).sln" Properties="Configuration=$(Configuration);Platform=Any CPU;BuildDir=$(BuildDir)">
    <Output ItemName="Targets" TaskParameter="TargetOutputs"/>
    </MSBuild>
  </Target>

  <Target Name="Test" DependsOnTargets="Build">
    <Exec Command="&quot;$(NUnitConsole)&quot; --out=&quot;$(BuildDir)\test-out.txt&quot; --labels=All @(TestTargets -> '&quot;$(OutDir)\%(Identity)&quot;', '')" />
  </Target>

  <Target Name="Doc" DependsOnTargets="GetVersion" >
    <PropertyGroup>
    <DocDir>$(BuildDir)\doc</DocDir>
  </PropertyGroup>
  <MakeDir Directories="$(DocDir)" />
  <Exec 
    Command="
      set OUTPUT_DIRECTORY=$(DocDir) &amp; 
      set VERSION=$(GfvNuGetVersion) &amp; 
      doxygen Doxyfile.build" 
    WorkingDirectory="$(SourceDir)"
  />
  </Target>

  <Target Name="ShowDoc" DependsOnTargets="Doc" >
  <Exec Command="explorer $(DocDir)\index.html" />
  </Target>

  <Target Name="Pack" DependsOnTargets="Build;Tag">
    <PropertyGroup>
    <PackageDir>$(BuildDir)\package</PackageDir>
  </PropertyGroup>
  <RemoveDir Directories="$(PackageDir)"/>
  <MakeDir Directories="$(PackageDir)" />
  <Exec WorkingDirectory="$(ReleaseDir)" Command="&quot;$(Nuget)&quot; pack &quot;$(SourceDir)\%(PackageProjects.Identity)&quot; -OutputDirectory &quot;$(PackageDir)&quot; -Version $(GfvNuGetVersion) -Verbosity detailed" />
  <ItemGroup>
    <PackageFiles Include="$(PackageDir)\sidi-util.$(GfvNuGetVersion).nupkg" />
  </ItemGroup>
  </Target>

  <Target Name="Tag" DependsOnTargets="GetVersion">
  <Exec WorkingDirectory="$(SourceDir)" Command="$(Git) tag --force v$(GfvSemVer)" />
  </Target>

  <Target Name="Push" DependsOnTargets="Test;Pack">
    <Exec WorkingDirectory="$(ReleaseDir)" Command="&quot;$(Nuget)&quot; push -Source https://www.nuget.org/api/v2/package &quot;%(PackageFiles.Identity)&quot;" />
  </Target>

  <Target Name="Release" DependsOnTargets="Push">
  </Target>
</Project>
